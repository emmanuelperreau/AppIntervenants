<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulateur Salaire - Agence O2</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#11183b">
    
    <!-- Config Agence -->
    <script src="config.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'media',
          theme: {
            extend: {
              colors: {
                slate: { 850: '#151e32', 900: '#0f172a' }
              }
            }
          }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        input[type=number] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-white min-h-screen pb-10">

    <!-- Header -->
    <header class="sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl z-40 border-b border-slate-200 dark:border-slate-800 shadow-sm">
        <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 text-slate-500 hover:text-[#11183b] dark:text-slate-400 dark:hover:text-white transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Retour</span>
            </a>
            <h1 class="text-base font-bold text-[#11183b] dark:text-white">Simulateur de Salaire</h1>
            <div class="w-5 h-5"></div> <!-- Spacer -->
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-4 slide-in">
        
        <!-- Info Banner -->
        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800 flex items-start gap-3">
            <div class="bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300 p-1.5 rounded-lg shrink-0">
                <i data-lucide="info" class="w-4 h-4"></i>
            </div>
            <p class="text-xs text-slate-600 dark:text-slate-300 leading-snug">
                Estimation indicative. Les montants réels peuvent varier selon votre situation personnelle et fiscale.
            </p>
        </div>

        <!-- 1. Contrat (Inputs) -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="px-5 py-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                <h3 class="font-bold text-sm uppercase text-slate-500 dark:text-slate-400">Votre Contrat</h3>
            </div>
            <div class="p-4 space-y-4">
                <!-- Taux Horaire -->
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Taux horaire brut</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="input-rate" value="12.02" step="0.01" class="w-24 text-right bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg py-2 px-3 font-bold text-[#11183b] dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <span class="text-sm font-bold text-slate-400">€</span>
                    </div>
                </div>
                <!-- Heures Hebdo -->
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Durée Hebdo</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="input-hours" value="24" step="0.5" class="w-24 text-right bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg py-2 px-3 font-bold text-[#11183b] dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <span class="text-sm font-bold text-slate-400">h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Variables (Inputs) -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="px-5 py-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                <h3 class="font-bold text-sm uppercase text-slate-500 dark:text-slate-400">Éléments Variables</h3>
            </div>
            <div class="p-4 space-y-4">
                <!-- KMs -->
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nbrs KM</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="input-kms" value="150" class="w-24 text-right bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg py-2 px-3 font-bold text-[#11183b] dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <span class="text-sm font-bold text-slate-400">km</span>
                    </div>
                </div>
                <!-- Titres Resto -->
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nbrs Titres restaurant</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="input-tickets" value="20" class="w-24 text-right bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg py-2 px-3 font-bold text-[#11183b] dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <span class="text-sm font-bold text-slate-400">/ mois</span>
                    </div>
                </div>
                <!-- Mutuelle -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                         <input type="checkbox" id="check-mutuelle" checked class="w-5 h-5 text-teal-500 rounded focus:ring-teal-500 border-gray-300">
                         <label for="check-mutuelle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Mutuelle (isolée)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="input-mutuelle-cost" value="20" class="w-20 text-right bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg py-1 px-2 text-sm font-bold text-slate-500 dark:text-slate-400 focus:outline-none focus:ring-1 focus:ring-teal-500">
                        <span class="text-sm font-bold text-slate-400">€</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Avantages Annuels (Pink Style) -->
        <div class="bg-pink-100 dark:bg-pink-900/30 rounded-2xl shadow-sm border border-pink-200 dark:border-pink-800 p-5 space-y-3">
            <h3 class="font-bold text-pink-800 dark:text-pink-300 text-sm uppercase mb-2">Avantages & Primes (Annuels/Ponctuels)</h3>
            
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Chèques Cadeau</span>
                <span class="font-bold text-[#11183b] dark:text-white">50,00 €</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Chèques Vacances</span>
                <span class="font-bold text-[#11183b] dark:text-white">80,00 €</span>
            </div>
             <div class="flex justify-between items-center pt-2 border-t border-pink-200 dark:border-pink-800/50">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Heures Complémentaires (Estim.)</span>
                <span id="res-heures-comp" class="font-bold text-[#11183b] dark:text-white">--,-- €</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Prime Carburant (Estim.)</span>
                <span id="res-prime-carburant" class="font-bold text-[#11183b] dark:text-white">--,-- €</span>
            </div>
        </div>

        <!-- 5. Total Moyen (Green Style) -->
        <div class="bg-green-500 rounded-2xl shadow-lg border-2 border-green-400 overflow-hidden text-white">
            <div class="p-5 flex justify-between items-center">
                <div>
                    <h3 class="font-black text-lg">Gain net mensuel moyen</h3>
                    <p class="text-sm font-semibold opacity-80 text-green-100">Lissé sur l'année (inclus primes)</p>
                </div>
                <div class="text-right">
                     <span id="res-total-moyen" class="block text-3xl font-black">--,-- €</span>
                     <span class="text-sm font-bold opacity-70">Smic net: <span id="res-smic-mensuel">--,-- €</span></span>
                </div>
            </div>
            <div class="px-5 py-3 bg-green-600/30 border-t border-green-400/30 flex justify-between items-center">
                 <span class="font-bold text-base">Gain net / heure moyen</span>
                 <div class="text-right">
                     <span id="res-total-horaire" class="block text-2xl font-black">--,-- €</span>
                     <span class="text-sm font-bold opacity-70">Smic net / heure : <span id="res-smic-horaire">--,-- €</span></span>
                 </div>
            </div>
        </div>

        <!-- Coût Employeur -->
        <div class="mt-6 text-center pb-safe">
            <p class="text-xs text-slate-400 font-medium">Coût global employeur estimé : <span id="res-cout-employeur" class="font-bold text-slate-600 dark:text-slate-300">--,-- €</span></p>
        </div>

    </main>

    <script>
        // INIT ICONS
        lucide.createIcons();

        // CONSTANTS
        const KM_RATE = 0.45;
        const TICKET_VALUE = 6.00; // Valeur faciale
        const TICKET_EMPLOYEE_SHARE = 3.00; // Part salariale (déduit du net)
        
        // Estimation charges patronales (coeff approximatif pour SMIC + réductions)
        // 1.25 est une moyenne basse prenant en compte les allègements Fillon sur bas salaires + mutuelle/prévoyance
        const CHARGES_PATRONALES_COEFF = 1.1; 

        // ELEMENTS
        const inputs = {
            rate: document.getElementById('input-rate'),
            hours: document.getElementById('input-hours'),
            kms: document.getElementById('input-kms'),
            tickets: document.getElementById('input-tickets'),
            mutuelleCheck: document.getElementById('check-mutuelle'),
            mutuelleCost: document.getElementById('input-mutuelle-cost')
        };

        const outputs = {
            // Optional elements (handled safely if missing)
            netMensuel: document.getElementById('res-net-mensuel'),
            netHoraire: document.getElementById('res-net-horaire'),
            primeCarburant: document.getElementById('res-prime-carburant'),
            heuresComp: document.getElementById('res-heures-comp'),
            
            // Required elements
            smicMensuel: document.getElementById('res-smic-mensuel'),
            smicHoraire: document.getElementById('res-smic-horaire'),
            totalMoyen: document.getElementById('res-total-moyen'),
            totalHoraire: document.getElementById('res-total-horaire'),
            coutEmployeur: document.getElementById('res-cout-employeur')
        };

        // LOAD AGENCY CONFIG
        function loadAgencyConfig() {
            if(typeof AGENCY_CONFIGS === 'undefined') return;

            // Get agency from URL
            const params = new URLSearchParams(window.location.search);
            const agencyId = params.get('agence') || 'nord-touraine';
            const config = AGENCY_CONFIGS[agencyId] || AGENCY_CONFIGS['nord-touraine'];

            if(config && config.remuneration && config.remuneration.mutuellePrice) {
                 // Convert "16,88 €" -> 16.88
                 const priceStr = config.remuneration.mutuellePrice.replace(',','.');
                 const price = parseFloat(priceStr);
                 
                 const inputMutuelle = document.getElementById('input-mutuelle-cost');
                 if(inputMutuelle && !isNaN(price)) {
                     inputMutuelle.value = price.toFixed(2);
                     // Disable input
                     inputMutuelle.disabled = true;
                     // Visual feedback for disabled state
                     inputMutuelle.classList.add('opacity-50', 'cursor-not-allowed', 'bg-slate-100', 'dark:bg-slate-700');
                     inputMutuelle.classList.remove('bg-slate-50', 'dark:bg-slate-900');
                 }
            }
        }

        // CALCULATION ENGINE
        function calculate() {
            // Lecture dynamique des valeurs
            const rate = parseFloat(inputs.rate.value) || 0;
            const hoursWeekly = parseFloat(inputs.hours.value) || 0;
            const kms = parseFloat(inputs.kms.value) || 0;
            const tickets = parseFloat(inputs.tickets.value) || 0;
            const mutuelleCost = inputs.mutuelleCheck.checked ? (parseFloat(inputs.mutuelleCost.value) || 0) : 0;

            // Calculs de base
            const hoursMonthly = hoursWeekly * 52 / 12;
            const salaireBrut = hoursMonthly * rate;
            
            // FORMULES UTILISATEUR CORRIGEES (Syntaxe % remplacée par décimales)
            
            // 1. Calcul du Net de Base
            // Formule: (SalaireBrut * 0.8869) - (((SalaireBrut * 0.9825) + Mutuelle) * 0.097)
            const netBase = salaireBrut - (salaireBrut * 0.1131) - (((salaireBrut * 0.9825) + mutuelleCost) * 0.097);

            // 2. Calcul du SMIC de Référence (Mensuel) pour ces heures
            const smicNetBase = (hoursMonthly * 12.02) - ((hoursMonthly * 12.02) * 0.1131) - ((((hoursMonthly * 12.02) * 0.9825) + mutuelleCost) * 0.097);

            // Calculs Annexes
            const gainKms = kms * KM_RATE;
            const costTickets = tickets * TICKET_EMPLOYEE_SHARE;
            
            // 3. Net Mensuel à Payer
            // netBase est le net après cotisations, mais il faut déduire la part mutuelle et ajouter tickets, et ajouter les KMs
            const netMensuel = netBase + gainKms + costTickets - mutuelleCost;
            
            // 4. SMIC Net à Payer (Comparatif équivalent avec même mutuelle déduite)
            const smicMensuelFinal = smicNetBase - mutuelleCost;

            // Affichage Résultats (avec vérification si l'élément existe)
            const realNetHoraire = hoursMonthly > 0 ? (netMensuel / hoursMonthly) : 0;
            const smicHoraireFinal = hoursMonthly > 0 ? (smicMensuelFinal / hoursMonthly) : 0;
            
            if(outputs.netMensuel) outputs.netMensuel.textContent = formatCurrency(netMensuel);
            if(outputs.netHoraire) outputs.netHoraire.textContent = formatCurrency(realNetHoraire);
            
            if(outputs.smicMensuel) outputs.smicMensuel.textContent = formatCurrency(smicMensuelFinal);
            if(outputs.smicHoraire) outputs.smicHoraire.textContent = formatCurrency(smicHoraireFinal);

            // Prime Carburant
            const primeCarburantAnnuelle = (hoursWeekly * 300) / 35;
            if(outputs.primeCarburant) outputs.primeCarburant.textContent = formatCurrency(primeCarburantAnnuelle);

            // Calcul Heures Complémentaires (Nouveau)
            // Formule: Base hebdo x 100 / 24
            const heuresComp = (hoursWeekly * 60) / 24;
            if(outputs.heuresComp) outputs.heuresComp.textContent = formatCurrency(heuresComp);

            // 5. Total Moyen (Avec Primes Annuelles)
            // Primes fixes (Cadeaux + Vacances + Heures Comp) + Carburant
            const primesAnnuelles = 50 + 80 + heuresComp + primeCarburantAnnuelle;
            const primeMensuelleLissee = primesAnnuelles / 12;
            
            const totalMoyen = netMensuel + primeMensuelleLissee;
            const totalHoraire = hoursMonthly > 0 ? (totalMoyen / hoursMonthly) : 0;

            if(outputs.totalMoyen) outputs.totalMoyen.textContent = formatCurrency(totalMoyen);
            if(outputs.totalHoraire) outputs.totalHoraire.textContent = formatCurrency(totalHoraire);

            // 6. Coût Global Employeur (Estimation)
            // Salaire Brut chargé + Kms + Tickets (part employeur 50%) + Mutuelle (part employeur 50%)
            const partPatronaleTickets = tickets * 3.00; // O2 paye 3€
            const partPatronaleMutuelle = mutuelleCost; // O2 paye 50% donc idem part salariale en valeur
            
            // Formule simplifiée : Brut chargé + avantages
            const coutGlobal = (salaireBrut * CHARGES_PATRONALES_COEFF) + gainKms + partPatronaleTickets + partPatronaleMutuelle;
            
            if(outputs.coutEmployeur) outputs.coutEmployeur.textContent = formatCurrency(coutGlobal);
        }

        function formatCurrency(val) {
            return val.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
        }

        // LISTENERS
        Object.values(inputs).forEach(input => {
            if(input) { // Sécurité si un input manque
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
            }
        });

        // INIT
        loadAgencyConfig();
        calculate();

    </script>
</body>
</html>